<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Erdem M. Karak√∂yl√º">
<meta name="dcterms.date" content="2025-03-29">
<meta name="description" content="Using Satellite Data to Predict and Explain PFGs with XGBoost and SHAP">

<title>Retrieving Phytoplankton Functional Groups from Hyperspectral Ocean Color using XGBoost ‚Äì Erdem Karak√∂yl√º</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-b53751a350365c71b6c909e95f209ed1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-22381ab97ffb8a420d3841344730e94d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Erdem Karak√∂yl√º</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../portfolio.html"> 
<span class="menu-text">Portfolio</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resume.html"> 
<span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#remote-sensing-approaches-for-pfg-retrieval" id="toc-remote-sensing-approaches-for-pfg-retrieval" class="nav-link" data-scroll-target="#remote-sensing-approaches-for-pfg-retrieval"><span class="header-section-number">1.1</span> Remote Sensing Approaches for PFG Retrieval</a></li>
  <li><a href="#study-contribution-and-approach" id="toc-study-contribution-and-approach" class="nav-link" data-scroll-target="#study-contribution-and-approach"><span class="header-section-number">1.2</span> Study Contribution and Approach</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results"><span class="header-section-number">2</span> Results</a>
  <ul class="collapse">
  <li><a href="#hyperparameter-optimization-hpo" id="toc-hyperparameter-optimization-hpo" class="nav-link" data-scroll-target="#hyperparameter-optimization-hpo"><span class="header-section-number">2.1</span> Hyperparameter Optimization (HPO)</a></li>
  <li><a href="#optimized-model-validation" id="toc-optimized-model-validation" class="nav-link" data-scroll-target="#optimized-model-validation"><span class="header-section-number">2.2</span> Optimized Model Validation</a></li>
  <li><a href="#xai-with-shapley-values" id="toc-xai-with-shapley-values" class="nav-link" data-scroll-target="#xai-with-shapley-values"><span class="header-section-number">2.3</span> XAI with Shapley Values</a></li>
  </ul></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion"><span class="header-section-number">3</span> Discussion</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">4</span> Conclusion</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Retrieving Phytoplankton Functional Groups from Hyperspectral Ocean Color using XGBoost</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Plankton</div>
    <div class="quarto-category">Regression</div>
    <div class="quarto-category">XGBoost</div>
    <div class="quarto-category">Shap</div>
    <div class="quarto-category">Explainable AI</div>
  </div>
  </div>

<div>
  <div class="description">
    Using Satellite Data to Predict and Explain PFGs with XGBoost and SHAP
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Erdem M. Karak√∂yl√º </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 29, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
üìÇ Code &amp; Notebooks
</div>
</div>
<div class="callout-body-container callout-body">
<p>All code and demo notebooks are available in the <a href="https://github.com/erdemkarakoylu/toa_2_phyto_ml">GitHub repository</a>.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" open="true">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Abstract
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Phytoplankton functional groups (PFGs) play a key role in ocean biogeochemical cycling, climate regulation, and marine ecosystem dynamics. Accurate quantification of these groups from satellite ocean color data remains challenging due to spectral similarities among phytoplankton types and the limitations of existing empirical and semi-analytical models.</p>
<p>In this study, we used an extreme gradient boosting (XGBoost) tree-based regression model to retrieve multiple PFGs and total chlorophyll-a concentrations from simulated hyperspectral remote sensing top-of-atmosphere (TOA) ocean color data as well as some ancillary data. The intent is to mimic what could be gathered from the NASA Plankton, Aerosol, Cloud, ocean Ecosystem (PACE) mission and auxiliary data sources to characterize the environment.</p>
<p>In its final form, the model, validated on an out-of-sample set, demonstrated strong predictive performance across most functional groups, with R¬≤ values exceeding 0.95. Dinoflagellate retrievals showed lower accuracy (R¬≤ = 0.53). Further analysis revealed that temperature was a key predictor alongside hyperspectral TOA radiance, suggesting that integrating external temperature data could enhance future retrieval models.</p>
<p>Furthermore, despite using only 10% of the available hyperspectral bands, feature importance analysis showed that specific spectral regions disproportionately contributed to model predictions. These findings highlight the potential of machine learning for phytoplankton classification and inform future algorithm development for hyperspectral ocean color missions.</p>
</div>
</div>
</div>
<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>Phytoplankton functional groups (PFGs) play a fundamental role in marine biogeochemical cycles, influencing carbon sequestration, nutrient fluxes, and global climate feedbacks. Different functional groups contribute uniquely to these processes; for example, diatoms facilitate carbon export through rapid sinking, cyanobacteria fix atmospheric nitrogen, and coccolithophores regulate carbonate chemistry via calcification <span class="citation" data-cites="Maranon2015 Boyd2010">(<a href="#ref-Maranon2015" role="doc-biblioref">Mara√±√≥n et al. 2015</a>; <a href="#ref-Boyd2010" role="doc-biblioref">Boyd and Doney 2010</a>)</span>. Identifying and quantifying these groups from space is crucial for understanding their ecological functions, detecting environmental changes, and improving ocean biogeochemical models <span class="citation" data-cites="Bopp2005 Laufkotter2015">(<a href="#ref-Bopp2005" role="doc-biblioref">Bopp et al. 2005</a>; <a href="#ref-Laufkotter2015" role="doc-biblioref">Laufk√∂tter et al. 2015</a>)</span>. However, current satellite ocean-color products primarily provide total chlorophyll <em>a</em> concentrations, which do not directly indicate community composition. To address this gap, various remote sensing algorithms have been developed to infer phytoplankton diversity, each with limitations in distinguishing certain groups and quantifying their biomass accurately <span class="citation" data-cites="Mouw2017">(<a href="#ref-Mouw2017" role="doc-biblioref">Mouw et al. 2017</a>)</span>.</p>
<section id="remote-sensing-approaches-for-pfg-retrieval" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="remote-sensing-approaches-for-pfg-retrieval"><span class="header-section-number">1.1</span> Remote Sensing Approaches for PFG Retrieval</h3>
<p>Phytoplankton classification from satellite remote sensing has traditionally relied on empirical and semi-analytical methods. Empirical band-ratio techniques, such as PHYSAT, classify dominant phytoplankton groups based on anomalies in spectral reflectance but are often region-specific and limited to broad functional classes <span class="citation" data-cites="Alvain2005 Alvain2008">(<a href="#ref-Alvain2005" role="doc-biblioref">Alvain et al. 2005</a>, <a href="#ref-Alvain2008" role="doc-biblioref">2008</a>)</span>. Semi-analytical models, in contrast, use inherent optical properties (IOPs) to infer phytoplankton composition from satellite reflectance, providing a more mechanistic approach <span class="citation" data-cites="Hirata2011">(<a href="#ref-Hirata2011" role="doc-biblioref">Hirata et al. 2011</a>)</span>. Hybrid models incorporate additional environmental variables, such as sea surface temperature and total chlorophyll, to infer community structure <span class="citation" data-cites="Brewin2010">(<a href="#ref-Brewin2010" role="doc-biblioref">Brewin et al. 2010</a>)</span>.</p>
<p>More recently, hyperspectral ocean-color sensors, such as NASA‚Äôs Plankton, Aerosol, Cloud, ocean Ecosystem (PACE) mission, may have the potential to improve PFG retrieval by capturing finer spectral features associated with phytoplankton pigments <span class="citation" data-cites="Dierssen2023">(<a href="#ref-Dierssen2023" role="doc-biblioref">Dierssen et al. 2023</a>)</span>. That is not to say that hyperspectral resolution is sufficient on its own. Optical similarity between different groups, depth-related biases in surface measurements, as well as associated measurement uncertainties inherenth to the noisy marine environment will likely hinder retrieval accuracy <span class="citation" data-cites="IOCCG2014">(<a href="#ref-IOCCG2014" role="doc-biblioref">IOCCG 2014</a>)</span>. Most current models either estimate phytoplankton size classes or assign a single dominant group per pixel, often failing to capture the complexity of mixed communities <span class="citation" data-cites="Ciotti2002">(<a href="#ref-Ciotti2002" role="doc-biblioref">Ciotti, Lewis, and Cullen 2002</a>)</span>.</p>
</section>
<section id="study-contribution-and-approach" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="study-contribution-and-approach"><span class="header-section-number">1.2</span> Study Contribution and Approach</h3>
<p>In this study, we introduce <strong>extreme gradient boosting (XGBoost)</strong> <span class="citation" data-cites="Chen2016">(<a href="#ref-Chen2016" role="doc-biblioref">Chen and Guestrin 2016</a>)</span> as a novel approach for retrieving phytoplankton functional groups from satellite ocean color data. XGBoost is a scalable ensemble learning algorithm that has demonstrated high performance in complex classification tasks but has not yet been widely applied to PFG retrieval. XGBoost is also less opaque than neural networks, and can deal better with highly correlated (spectral) data of varying scales.</p>
<p>Recent studies have demonstrated the potential of XGBoost in related applications, such as harmful algal bloom detection <span class="citation" data-cites="Izadi2021">(<a href="#ref-Izadi2021" role="doc-biblioref">Izadi et al. 2021</a>)</span> and phytoplankton biomass estimation <span class="citation" data-cites="Yan2025">(<a href="#ref-Yan2025" role="doc-biblioref">Yan et al. 2025</a>)</span>, highlighting its suitability for remote sensing applications. Our work aligns with the objectives of the PACE mission by contributing an advanced classification algorithm that enhances hyperspectral monitoring of phytoplankton diversity <span class="citation" data-cites="Zhang2024">(<a href="#ref-Zhang2024" role="doc-biblioref">Zhang et al. 2024</a>)</span>. To our knowledge, this is the first application of XGBoost for PFG classification in ocean color remote sensing, offering a robust alternative to traditional retrieval methods.</p>
<p>Our approach was to leverage a large dataset of simulated hyperspectral TOA radiance and associated environmental variables to improve both the discrimination of functional groups and the quantification of their biomass. Previous remote sensing algorithms often classified only a dominant PFG or broad size class <span class="citation" data-cites="Mouw2017">(<a href="#ref-Mouw2017" role="doc-biblioref">Mouw et al. 2017</a>)</span> and relied on empirical band relationships that lacked generalizability <span class="citation" data-cites="Hirata2011">(<a href="#ref-Hirata2011" role="doc-biblioref">Hirata et al. 2011</a>)</span>. By utilizing a machine learning framework capable of integrating multiple features, our approach reduces classification errors and enhances retrieval precision. Moreover the application of eXplainable AI (XAI) techniques to relate predictions to their input may further guide future efforts to improve PFG quantification.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Methods
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<section id="data-preparation-and-feature-selection" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="data-preparation-and-feature-selection"><span class="header-section-number">1.3</span> Data Preparation and Feature Selection</h3>
<p>We utilized a simulated dataset representing the world ocean over 31 days, corresponding to December 2021. The simulation generated hyperspectral remote sensing TOA radiance data, emulating a sensor configuration akin to that of the PACE instrument. Due to the high dimensionality of the original spectral data, we conducted an initial exploratory analysis and observed strong correlations among many of the channels. To reduce redundancy while preserving essential spectral information, we retained 51 channels by selecting one channel every ten. Note that despite this feature subsampling, spectral features are characterized by high degree of correlation we opted against applying principal component analysis for two principal reasons. The first reason is to avoid overemphasizing blue water signal contributed by the extensive oceanic regions present in a global satellite scene, and which could mask coastal processes of interest. The second reason is that tree-based algorithms such as XGBoost are resiliant to input multicollinearity. To further contextualize the ocean color signal, we also included auxiliary environmental variables such as temperature and latitude. Though not available from actual PACE measurements, climatology including temperature could be readily sourced elsewhere to augment observations on hand.</p>
<p>The dataset was divided into training and test sets using an 80/20 split. The training set was exclusively used for model development and hyperparameter optimization (see next section), while the test set was set aside until the final validation of model performance.</p>
</section>
<section id="model-choice" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="model-choice"><span class="header-section-number">1.4</span> Model Choice</h3>
<p>We employed an XGBoost Regressor model with a multi-output regression head to predict simultaneously multiple phytoplankton functional groups as well as total chlorophyll-<em>a</em> concentration. XGBoost is a high-performance, scalable implementation of gradient boosting that has become a popular choice for a wide range of regression and classification tasks <span class="citation" data-cites="Chen2016">(<a href="#ref-Chen2016" role="doc-biblioref">Chen and Guestrin 2016</a>)</span>. This approach consists in building an ensemble of decision trees sequentially, where each new tree attempts to correct the errors made by the previous trees. By optimizing a regularized objective function, XGBoost effectively controls overfitting while enhancing prediction accuracy. Its efficient handling highly correlated data, support for parallel computation, and flexible regularization mechanisms make it particularly well-suited for complex modeling tasks.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Hyperparameter Optimization and Model Training
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Given the complexity of the problem and the high dimensionality of the input features, it was critical to optimize the hyperparameters to achieve robust performance and prevent overfitting. To this end, we conducted hyperparameter optimization using the Optuna version 4.2.1 library <span class="citation" data-cites="Akiba2019">(<a href="#ref-Akiba2019" role="doc-biblioref">Akiba et al. 2019</a>)</span>. Specifically, we employed the efficient Tree-structured Parzen Estimator (TPE) algorithm <span class="citation" data-cites="Bergstra2011">(<a href="#ref-Bergstra2011" role="doc-biblioref">Bergstra et al. 2011</a>)</span>. TPE is a Bayesian optimization method that iteratively builds probabilistic models of the hyperparameter space based on past evaluation results. By modeling the distributions of promising and less promising hyperparameter configurations, TPE suggests new parameter sets to explore, focusing the search on regions likely to yield improved performance. To further enhance the efficiency of the optimization process, we utilized Optuna‚Äôs MedianPruner with n_warmup_steps=5. This pruner automatically stops unpromising trials during the early stages of training (after at least 5 steps) if their intermediate results indicate they are unlikely to outperform the median performance of completed trials. The optimization step used an objective function to minimize the root mean squared error (RMSE) computed via three-fold cross-validation on the training set. The hyperparameters under investigation are lthe learning rate, maximum tree depth, number of estimators, subsample ratio, column subsample ratio, and gamma (the minimum loss reduction required to make a further partition on a leaf node); <em>cf</em> <a href="#tbl-hparam" class="quarto-xref">Table&nbsp;1</a> for further details. The Bayesian optimization procedure allowed us to efficiently explore the hyperparameter space by leveraging past trial information to prune unpromising candidate parameter sets early, thereby reducing overall computational cost.</p>
<p>Once the optimization step complete, we instantiated the XGBoost model with the best set of hyperparameters and trained it on the full training set.</p>
<div id="tbl-hparam" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-hparam-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Hyperparameter ranges and their corresponding sampling strategy used in optimization.
</figcaption>
<div aria-describedby="tbl-hparam-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 18%">
<col style="width: 20%">
<col style="width: 35%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Hyperparameter</strong></th>
<th style="text-align: right;"><strong>Low bound</strong></th>
<th style="text-align: right;"><strong>High bound</strong></th>
<th style="text-align: right;"><strong>Sampling Distribution</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Learning rate</td>
<td style="text-align: right;"><span class="math inline">\(10^{-3}\)</span></td>
<td style="text-align: right;"><span class="math inline">\(0.3\)</span></td>
<td style="text-align: right;">Log Uniform</td>
</tr>
<tr class="even">
<td>Max. tree depth</td>
<td style="text-align: right;"><span class="math inline">\(3\)</span></td>
<td style="text-align: right;"><span class="math inline">\(10\)</span></td>
<td style="text-align: right;">Uniform Integer</td>
</tr>
<tr class="odd">
<td>Estimator number</td>
<td style="text-align: right;"><span class="math inline">\(50\)</span></td>
<td style="text-align: right;"><span class="math inline">\(500\)</span></td>
<td style="text-align: right;">Uniform Integer</td>
</tr>
<tr class="even">
<td>Row sample fraction</td>
<td style="text-align: right;"><span class="math inline">\(0.5\)</span></td>
<td style="text-align: right;"><span class="math inline">\(1.0\)</span></td>
<td style="text-align: right;">Uniform Float</td>
</tr>
<tr class="odd">
<td>Column sample frac.</td>
<td style="text-align: right;"><span class="math inline">\(0.5\)</span></td>
<td style="text-align: right;"><span class="math inline">\(1.0\)</span></td>
<td style="text-align: right;">Uniform Float</td>
</tr>
<tr class="even">
<td>Gamma</td>
<td style="text-align: right;"><span class="math inline">\(10^{-8}\)</span></td>
<td style="text-align: right;"><span class="math inline">\(1.0\)</span></td>
<td style="text-align: right;">Log Uniform</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="model-evaluation-and-explainable-ai-xai" class="level3" data-number="1.5">
<h3 data-number="1.5" class="anchored" data-anchor-id="model-evaluation-and-explainable-ai-xai"><span class="header-section-number">1.5</span> Model Evaluation and eXplainable AI (XAI)</h3>
<p>Once the optimal hyperparameter combination was identified, we retrained the final XGBoost model on the full training set using these optimized settings. Finally, we evaluated the performance of the retrained model on the held-out test set to assess its generalizability.</p>
<section id="prediction-explainability" class="level4" data-number="1.5.1">
<h4 data-number="1.5.1" class="anchored" data-anchor-id="prediction-explainability"><span class="header-section-number">1.5.1</span> Prediction Explainability</h4>
<p>To enhance interpretability and gain insights into how different input features influence model predictions, we employed <strong>Shapley Additive Explanations (SHAP)</strong>, a widely used explainable AI (XAI) framework for interpreting complex machine learning models. SHAP is named after the concept of Shapley values, which consists in assigning importance values to each input feature by estimating its contribution to the model‚Äôs predictions across different samples. The method is rooted in cooperative game theory, and guarantees a fair distribution of importance scores among features <span class="citation" data-cites="Lundberg2017">(<a href="#ref-Lundberg2017" role="doc-biblioref">Lundberg and Lee 2017</a>)</span>.</p>
<p>Given the computational complexity of our XGBoost model and the high dimensionality of the dataset, we conducted SHAP analysis on a <strong>random subsample of 10,000 observations from the test set</strong>. This subset was selected to balance computational feasibility while maintaining a representative sample of phytoplankton spectral diversity.</p>
<p>We generated <strong>SHAP summary plots</strong>, which provide a comprehensive visualization of feature importance and the directionality of their influence on model outputs. These plots display the magnitude of each feature‚Äôs impact across all predictions, helping to identify the most influential spectral and environmental variables in determining phytoplankton functional group composition. The insights gained from SHAP analysis aid in validating model behavior and ensuring its ecological plausibility.</p>
<section id="code-availability" class="level5" data-number="1.5.1.1">
<h5 data-number="1.5.1.1" class="anchored" data-anchor-id="code-availability"><span class="header-section-number">1.5.1.1</span> Code Availability</h5>
<p>All analysis and modeling code used in this study was written in Python 3.12. This code is <a href="https://github.com/erdemkarakoylu/toa_2_phyto_ml">publicly available on GitHub</a>.</p>
</section>
</section>
</section>
</div>
</div>
</div>
</section>
</section>
<section id="results" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="results"><span class="header-section-number">2</span> Results</h2>
<section id="hyperparameter-optimization-hpo" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="hyperparameter-optimization-hpo"><span class="header-section-number">2.1</span> Hyperparameter Optimization (HPO)</h3>
<p>We performed hyperparameter optimization using a Bayesian optimization framework implemented with Optuna. The metric used for optimization was the average RMSE (in units of <span class="math inline">\(mgL^{-1} Chl_a\)</span> ) computed over the cross-validation folds and across all target compartments. The ‚Äúfull HPO run‚Äù best parameters indicate a relatively aggressive model, characterized by deep trees with many estimators, a moderate learning rate, and little regularization via gamma.</p>
<p>The best trial finished with an RMSE of <span class="math inline">\(0.116mgL^{-1} Chl_a\)</span>. Below is the list of hyperparameters researched, the optimal values found, and an interpretation of these values:</p>
<ul>
<li><p>Learning Rate (learning_rate): <span class="math inline">\(0.083\)</span> - This moderate learning rate suggests the model takes reasonably sized steps when updating that are neither too aggressive (which might lead to overshooting the optimum) nor too conservative (which could slow down convergence).</p></li>
<li><p>Max Depth (max_depth): <span class="math inline">\(10\)</span> - A depth of 10 allows the trees to capture complex interactions. This may indicate that the data has non-linear relationships that benefit from deeper trees. Such a depth can be associated with overfitting. The cross-validation process during HPO should minimize this however.</p></li>
<li><p>Number of Estimators (n_estimators): <span class="math inline">\(466\)</span> -Building around 466 trees indicates the ensemble haa to tackle inherent complexity in the data that was not apparetn during the Exploratory Data Analysis phase. A larger number of trees generally improves performance‚Äîup to a point before overfitting becomse a risk. This number in conjunction with the cross validation process suggest this number strikes a balance between performance and overfitting.</p></li>
<li><p>Subsampling (subsample): <span class="math inline">\(0.658\)</span> - This indicates each of the 466 trees is using roughly 66% of the data. This introduces randomness that helps prevent overfitting as not all samples in any cross-validation fold are used to build every tree.</p></li>
<li><p>Features used per tree (colsample_bytree): <span class="math inline">\(0.894\)</span> - Using about 89% of the features per tree indicates that most features are informative, and the model is allowed to consider almost the full feature set at each split. - See features used in the Methods section.</p></li>
<li><p>Gamma (gamma): <span class="math inline">\(8.63e-06\)</span> - An extremely low gamma value means that almost no minimum loss reduction is required to make a split. This implies that the algorithm will split more readily, potentially capturing fine details. Awareness of this hyperparameter values is important as low gamma can risk overfitting.</p></li>
</ul>
</section>
<section id="optimized-model-validation" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="optimized-model-validation"><span class="header-section-number">2.2</span> Optimized Model Validation</h3>
<p>The next step was to load the best set of hyperparameter (listed above) into the model and retrain the model on the entire training set. The optimized and trained model was then validated using the test set, which prior to the HPO process and until this step had been set aside.</p>
<div id="fig-gof" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gof-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/goodness-of-fit_rrs_env.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gof-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Goodness-of-fit plots for all groups and total chorophyll <em>a</em>, measured on out-of-sample data set. THe model is able to predict with very good accuracy. Dinoflagellates are the notable exception.
</figcaption>
</figure>
</div>
<p>A more complete set of metrics are summarized in table <a href="#tbl-metrics" class="quarto-xref">Table&nbsp;2</a> See further below for metrics explanation.</p>
<div id="tbl-metrics" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-metrics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Performance metrics of optimized and trained model on hold-out set.
</figcaption>
<div aria-describedby="tbl-metrics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 17%">
<col style="width: 10%">
<col style="width: 12%">
<col style="width: 11%">
<col style="width: 13%">
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th>Metric</th>
<th style="text-align: right;">Diatom</th>
<th style="text-align: right;">Chloroph.</th>
<th style="text-align: right;">Cyanobac</th>
<th style="text-align: right;">Coccolith.</th>
<th style="text-align: right;">Dinoflag.</th>
<th style="text-align: right;">Phaeo</th>
<th>Tot. Chl_a</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>MSE</strong></td>
<td style="text-align: right;">0.00034</td>
<td style="text-align: right;">0.00010</td>
<td style="text-align: right;">2.89e-06</td>
<td style="text-align: right;">8.59e-05</td>
<td style="text-align: right;">1.96e-05</td>
<td style="text-align: right;">0.00011</td>
<td>0.000193</td>
</tr>
<tr class="even">
<td><strong>RMSE</strong></td>
<td style="text-align: right;">0.0184</td>
<td style="text-align: right;">0.0100</td>
<td style="text-align: right;">0.0017</td>
<td style="text-align: right;">0.00927</td>
<td style="text-align: right;">0.00443</td>
<td style="text-align: right;">0.0105</td>
<td>0.0139</td>
</tr>
<tr class="odd">
<td><strong>MAE</strong></td>
<td style="text-align: right;">0.00878</td>
<td style="text-align: right;">0.0042</td>
<td style="text-align: right;">0.00078</td>
<td style="text-align: right;">0.0042</td>
<td style="text-align: right;">0.000637</td>
<td style="text-align: right;">0.00313</td>
<td>0.00728</td>
</tr>
<tr class="even">
<td><strong>R-squared</strong></td>
<td style="text-align: right;">0.979</td>
<td style="text-align: right;">0.958</td>
<td style="text-align: right;">0.996</td>
<td style="text-align: right;">0.985</td>
<td style="text-align: right;">0.530</td>
<td style="text-align: right;">0.999</td>
<td>0.999</td>
</tr>
<tr class="odd">
<td><strong>MAE/StDev</strong></td>
<td style="text-align: right;">0.0691</td>
<td style="text-align: right;">0.0858</td>
<td style="text-align: right;">0.0302</td>
<td style="text-align: right;">0.0563</td>
<td style="text-align: right;">0.0986</td>
<td style="text-align: right;">0.00754</td>
<td>0.0182</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Explanation of metrics
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><p><strong>Mean Squared Error (MSE):</strong><br>
MSE is the average of the squared differences between the predicted and true values. Squaring the errors emphasizes larger deviations, making MSE sensitive to outliers. In our context, MSE is expressed in units of (mg‚ÄØL<span class="math inline">\(^{-1}\)</span> Chl<span class="math inline">\(_a\)</span>)<span class="math inline">\(^2\)</span>. Lower MSE values indicate better model performance.</p></li>
<li><p><strong>Root Mean Squared Error (RMSE):</strong><br>
RMSE is the square root of the MSE, bringing the error metric back to the original units (mg‚ÄØL<span class="math inline">\(^{-1}\)</span> Chl<span class="math inline">\(_a\)</span>). It provides a direct measure of the average prediction error magnitude. Lower RMSE values suggest that the model‚Äôs predictions are closer to the true values.</p></li>
<li><p><strong>Mean Absolute Error (MAE):</strong><br>
MAE calculates the average absolute difference between predicted and true values. Unlike MSE, it does not square the errors, so it is less sensitive to large outliers. MAE is also expressed in the same units as the target variable (mg‚ÄØL<span class="math inline">\(^{-1}\)</span> Chl<span class="math inline">\(_a\)</span>). A lower MAE indicates better predictive accuracy.</p></li>
<li><p><strong>Coefficient of Determination (R-squared):</strong><br>
R-squared measures the proportion of the variance in the dependent variable that is predictable from the independent variables. It ranges from 0 to 1, where a value closer to 1 indicates that the model explains a high proportion of the variance in the data. In our results, high R-squared values generally indicate strong model performance, although lower values (e.g., for dinoflagellates) suggest room for improvement.</p></li>
<li><p><strong>MAE/StDev<span class="math inline">\(_{true}\)</span>:</strong><br>
This ratio compares the mean absolute error to the standard deviation of the true values. It provides a relative measure of error by indicating how the average error compares to the inherent variability in the data. A lower ratio implies that the model‚Äôs prediction error is small relative to the natural variability of the observations.</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="xai-with-shapley-values" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="xai-with-shapley-values"><span class="header-section-number">2.3</span> XAI with Shapley Values</h3>
<p>The SHAP summary plots provides insights into feature importance and their effects on model predictions for phytoplankton functional groups.</p>
<div id="fig-shap" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-shap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-shap" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-diatoms" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-diatoms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/shap_rrs_env_dia.png" id="fig-diatoms" class="img-fluid figure-img" data-ref-parent="fig-shap">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-diatoms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a)
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-shap" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-chloro" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-chloro-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/shap_rrs_env_chl.png" id="fig-chloro" class="img-fluid figure-img" data-ref-parent="fig-shap">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-chloro-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-shap" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-cyano" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-cyano-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/shap_rrs_env_cya.png" id="fig-cyano" class="img-fluid figure-img" data-ref-parent="fig-shap">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-cyano-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-shap" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-coccos" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-coccos-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/shap_rrs_env_coc.png" id="fig-coccos" class="img-fluid figure-img" data-ref-parent="fig-shap">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-coccos-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-shap" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-dinos" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-dinos-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/shap_rrs_env_din.png" id="fig-dinos" class="img-fluid figure-img" data-ref-parent="fig-shap">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-dinos-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(e)
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-shap" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-phaeo" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-phaeo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/shap_rrs_env_pha.png" id="fig-phaeo" class="img-fluid figure-img" data-ref-parent="fig-shap">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-phaeo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(f)
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-shap" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-tot_chl" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-tot_chl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/shap_rrs_env_tot_cphyl.png" id="fig-tot_chl" class="img-fluid figure-img" data-ref-parent="fig-shap">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-tot_chl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(g)
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-shap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Shapley values are shown for each functional group and for total chlorophyll. Features are ranked by most to least impactful, from top to bottom. Only the top 6 predictive features are shown. Along the x-axis, positive SHAP values indicate a positive relationship with the predicted; negative values, a negative one. Wider sections indicate greater variability. The color gradient represents feature values, with red for high values and blue for low values. The midpoint of the color bar reflects a percentile-based central value, not necessarily the mean, median, or mode, as it depends on the feature‚Äôs distribution.
</figcaption>
</figure>
</div>
<p>Most saliently, temperature was the top factor for all phytoplankton groups but is not a primordial feature in quantifying dinoflagellates.</p>
</section>
</section>
<section id="discussion" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="discussion"><span class="header-section-number">3</span> Discussion</h2>
<p>The results presented here demonstrate that machine learning, particularly XGBoost, can effectively retrieve phytoplankton functional group (PFG) concentrations and total chlorophyll-a from hyperspectral top-of-atmosphere (TOA) data and auxiliary variables. The model performed well across most PFGs, with root mean squared error (RMSE) values under 0.02 mg m‚Åª¬≥ and R¬≤ values exceeding 0.95. The exception was dinoflagellates, which exhibited significantly lower predictive accuracy (R¬≤ ‚âà 0.53), a result also reflected in their higher normalized MAE and MAPE values.</p>
<p>Feature importance analysis using SHAP values revealed that temperature was among the top six predictors for all groups except dinoflagellates, for which no strong dependence on any single environmental feature emerged. These patterns point to functional differences in ecological drivers between PFGs. In particular, the centrality of temperature for most groups highlights its role as a proxy for environmental gradients, biogeography, and metabolic scaling.</p>
<p>Dinoflagellates do not exhibit a single, well-defined biogeographical zone of dominance the way cyanobacteria (tropical oligotrophic waters), diatoms (high latitudes and upwelling systems), or coccolithophores (subpolar blooms) do <span class="citation" data-cites="Boyd2010 Buitenhuis2013 Gregg2019">(<a href="#ref-Boyd2010" role="doc-biblioref">Boyd and Doney 2010</a>; <a href="#ref-Buitenhuis2013" role="doc-biblioref">Buitenhuis 2013</a>; <a href="#ref-Gregg2019" role="doc-biblioref">Gregg and Rousseaux 2019</a>)</span>. Instead, they are often considered ecological opportunists, occupying a broad range of regions, particularly stratified, nutrient-depleted, and temperate to tropical environments <span class="citation" data-cites="Smayda2001 Kibler2015">(<a href="#ref-Smayda2001" role="doc-biblioref">Smayda and Reynolds 2001</a>; <a href="#ref-Kibler2015" role="doc-biblioref">Kibler 2015</a>)</span>. Their distribution is governed less by temperature per se than by water column stability, nutrient availability (especially high N:P conditions), and their ability to exploit mixotrophic strategies <span class="citation" data-cites="Jeong2010 Glibert2001 Flynn2013">(<a href="#ref-Jeong2010" role="doc-biblioref">Jeong 2010</a>; <a href="#ref-Glibert2001" role="doc-biblioref">P. M. et al. Glibert 2001</a>; <a href="#ref-Flynn2013" role="doc-biblioref">Flynn 2013</a>)</span>. Several studies suggest that warming-driven increases in stratification may promote shifts from diatom- to dinoflagellate-dominated systems‚Äînot because dinoflagellates prefer warmer temperatures, but because they thrive in the low-nutrient, low-turbulence conditions that warming often produces <span class="citation" data-cites="Glibert2020 Peperzak2003 Fu2012">(<a href="#ref-Glibert2020" role="doc-biblioref">P. M. Glibert 2020</a>; <a href="#ref-Peperzak2003" role="doc-biblioref">Peperzak 2003</a>; <a href="#ref-Fu2012" role="doc-biblioref">Fu 2012</a>)</span>.</p>
<p>These ecological patterns are further supported by physiological observations. Anderson et al. <span class="citation" data-cites="Anderson2021">(<a href="#ref-Anderson2021" role="doc-biblioref">Anderson et al. 2021</a>)</span> demonstrated that dinoflagellates exhibit shallower thermal performance curves compared to other PFGs, with lower maximum growth rates and broader thermal tolerance. In contrast, diatoms and cyanobacteria display distinct thermal optima and strong growth responses to temperature. This generalist thermal profile likely explains why temperature was not a dominant predictor for dinoflagellates in our model. Instead, their success appears linked to emergent ecosystem conditions‚Äîsuch as stratification, irradiance, and nutrient regime‚Äîthat are only partially captured by the input features used here. Our SHAP-based feature interpretation supports this ecological understanding and underscores the need to include more nuanced environmental predictors in future modeling efforts.</p>
<p>The strength of the model, particularly for diatoms, coccolithophores, and phaeocystis, suggests that important spectral and environmental signals are being captured despite substantial dimensionality reduction. This supports the feasibility of operational PFG retrieval using compressed hyperspectral data, especially when paired with interpretable machine learning models.</p>
<p>However, this study is based on simulated TOA radiance data, and real-world deployment will depend on atmospheric correction, instrument fidelity, and access to reliable ancillary predictors. Future work should validate the model on actual PACE observations and incorporate additional features‚Äîsuch as nutrient proxies, light attenuation, and mixed layer depth‚Äîto better capture ecological dynamics across all functional groups.</p>
</section>
<section id="conclusion" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">4</span> Conclusion</h2>
<p>This study presents a novel, explainable machine learning framework for retrieving phytoplankton functional group concentrations from simulated hyperspectral top-of-atmosphere radiance data. Using an XGBoost model trained on reduced spectral features and auxiliary inputs such as temperature and latitude, we achieved high predictive performance across most functional groups and total chlorophyll-a. Model interpretation using SHAP values revealed that temperature was a key predictor for all groups except dinoflagellates, whose distribution appears to be driven by a broader suite of ecological factors such as stratification, nutrient limitation, and mixotrophy.</p>
<p>These findings reinforce the importance of tailoring remote sensing algorithms to the ecological and physiological diversity of phytoplankton groups. They also demonstrate that physically interpretable, high-performing models can be built even when using compressed hyperspectral inputs. However, the data tested is still simulated. Confirmation studies focusing on real sensor data (e.g., from the PACE mission) and incorporating additional oceanographic predictors to improve performance across all functional groups‚Äîespecially those, like dinoflagellates, whose success is governed by indirect or emergent environmental conditions.</p>
</section>
<section id="references" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Akiba2019" class="csl-entry" role="listitem">
Akiba, Takuya, Shotaro Sano, Toshihiko Yanase, Takeru Ohta, and Masanori Koyama. 2019. <span>‚ÄúOptuna: A Next-Generation Hyperparameter Optimization Framework.‚Äù</span> In <em>Proceedings of the 25th ACM SIGKDD International Conference on Knowledge Discovery and Data Mining (KDD)</em>, 2623‚Äì31. ACM. <a href="https://doi.org/10.1145/3292500.3330701">https://doi.org/10.1145/3292500.3330701</a>.
</div>
<div id="ref-Alvain2005" class="csl-entry" role="listitem">
Alvain, S., C. Moulin, Y. Dandonneau, and F. M. Br√©on. 2005. <span>‚ÄúRemote Sensing of Phytoplankton Groups in Case 1 Waters from Global SeaWiFS Imagery.‚Äù</span> <em>Deep-Sea Research I</em> 52 (11): 1989‚Äì2004. <a href="https://doi.org/10.1016/j.dsr.2005.06.015">https://doi.org/10.1016/j.dsr.2005.06.015</a>.
</div>
<div id="ref-Alvain2008" class="csl-entry" role="listitem">
Alvain, S., C. Moulin, Y. Dandonneau, and H. Loisel. 2008. <span>‚ÄúSeasonal Distribution and Succession of Dominant Phytoplankton Groups in the Global Ocean: A Satellite View.‚Äù</span> <em>Global Biogeochemical Cycles</em> 22 (3): GB3S04. <a href="https://doi.org/10.1029/2007GB003154">https://doi.org/10.1029/2007GB003154</a>.
</div>
<div id="ref-Anderson2021" class="csl-entry" role="listitem">
Anderson, Thomas R, Erik T Buitenhuis, Corinne Le Qu√©r√©, and Andrew Yool. 2021. <span>‚ÄúMarine Phytoplankton Functional Types Exhibit Diverse Responses to Thermal Change.‚Äù</span> <em>Nature Communications</em> 12 (1): 5126. <a href="https://doi.org/10.1038/s41467-021-25499-4">https://doi.org/10.1038/s41467-021-25499-4</a>.
</div>
<div id="ref-Bergstra2011" class="csl-entry" role="listitem">
Bergstra, James, R√©mi Bardenet, Yoshua Bengio, and Bal√°zs K√©gl. 2011. <span>‚ÄúAlgorithms for Hyper-Parameter Optimization.‚Äù</span> In <em>Advances in Neural Information Processing Systems</em>, edited by J. Shawe-Taylor, R. Zemel, P. Bartlett, F. Pereira, and K. Q. Weinberger. Vol. 24. Curran Associates, Inc. <a href="https://proceedings.neurips.cc/paper_files/paper/2011/file/86e8f7ab32cfd12577bc2619bc635690-Paper.pdf">https://proceedings.neurips.cc/paper_files/paper/2011/file/86e8f7ab32cfd12577bc2619bc635690-Paper.pdf</a>.
</div>
<div id="ref-Bopp2005" class="csl-entry" role="listitem">
Bopp, L., O. Aumont, P. Cadule, S. Alvain, and M. Gehlen. 2005. <span>‚ÄúResponse of Diatoms Distribution to Global Warming and Potential Implications: A Global Model Study.‚Äù</span> <em>Geophysical Research Letters</em> 32 (19): L19606. <a href="https://doi.org/10.1029/2005GL023653">https://doi.org/10.1029/2005GL023653</a>.
</div>
<div id="ref-Boyd2010" class="csl-entry" role="listitem">
Boyd, P. W., and S. C. Doney. 2010. <span>‚ÄúModelling Regional Responses by Marine Pelagic Ecosystems to Global Climate Change.‚Äù</span> <em>Geophysical Research Letters</em> 32 (19): L19606. <a href="https://doi.org/10.1029/2005GL023653">https://doi.org/10.1029/2005GL023653</a>.
</div>
<div id="ref-Brewin2010" class="csl-entry" role="listitem">
Brewin, R. J. W., S. Sathyendranath, T. Hirata, S. J. Lavender, R. Barciela, and N. J. Hardman-Mountford. 2010. <span>‚ÄúA Three-Component Model of Phytoplankton Size Class for the Atlantic Ocean.‚Äù</span> <em>Ecological Modelling</em> 221 (11): 1472‚Äì83. <a href="https://doi.org/10.1016/j.ecolmodel.2010.02.014">https://doi.org/10.1016/j.ecolmodel.2010.02.014</a>.
</div>
<div id="ref-Buitenhuis2013" class="csl-entry" role="listitem">
Buitenhuis, Erik T. et al. 2013. <span>‚ÄúBiogeochemical Fluxes Through Microzooplankton.‚Äù</span> <em>Global Biogeochemical Cycles</em> 27 (3): 847‚Äì58. <a href="https://doi.org/10.1002/gbc.20059">https://doi.org/10.1002/gbc.20059</a>.
</div>
<div id="ref-Chen2016" class="csl-entry" role="listitem">
Chen, Tianqi, and Carlos Guestrin. 2016. <span>‚Äú<span>XGBoost</span>: A Scalable Tree Boosting System.‚Äù</span> In <em>Proceedings of the 22nd ACM SIGKDD International Conference on Knowledge Discovery and Data Mining (KDD)</em>, 785‚Äì94. <a href="https://doi.org/10.1145/2939672.2939785">https://doi.org/10.1145/2939672.2939785</a>.
</div>
<div id="ref-Ciotti2002" class="csl-entry" role="listitem">
Ciotti, A. M., M. R. Lewis, and J. J. Cullen. 2002. <span>‚ÄúAssessment of the Relationships Between Dominant Cell Size in Natural Phytoplankton Communities and the Spectral Shape of the Absorption Coefficient.‚Äù</span> <em>Limnology and Oceanography</em> 47 (2): 404‚Äì17. <a href="https://doi.org/10.4319/lo.2002.47.2.0404">https://doi.org/10.4319/lo.2002.47.2.0404</a>.
</div>
<div id="ref-Dierssen2023" class="csl-entry" role="listitem">
Dierssen, H. M., M. M. Gierach, L. S. Guild, A. Mannino, J. Salisbury, S. Schollaert Uz, J. Scott, et al. 2023. <span>‚ÄúSynergies Between NASA‚Äôs Hyperspectral Aquatic Missions PACE, GLIMR, and SBG: Opportunities for New Science and Applications.‚Äù</span> <em>Journal of Geophysical Research: Biogeosciences</em> 128 (5): e2023JG007574. <a href="https://doi.org/10.1029/2023JG007574">https://doi.org/10.1029/2023JG007574</a>.
</div>
<div id="ref-Flynn2013" class="csl-entry" role="listitem">
Flynn, Kevin J. et al. 2013. <span>‚ÄúMisuse of the Phytoplankton‚ÄìZooplankton Dichotomy: The Need to Assign Organisms as Mixotrophs Within Plankton Functional Types.‚Äù</span> <em>Journal of Plankton Research</em> 35 (1): 3‚Äì11. <a href="https://doi.org/10.1093/plankt/fbs062">https://doi.org/10.1093/plankt/fbs062</a>.
</div>
<div id="ref-Fu2012" class="csl-entry" role="listitem">
Fu, Feixue et al. 2012. <span>‚ÄúInteractions Between Changing pCO‚ÇÇ, n Availability, and Temperature on the Marine Nitrogen Fixer Trichodesmium.‚Äù</span> <em>Global Change Biology</em> 18 (10): 3079‚Äì92. <a href="https://doi.org/10.1111/j.1365-2486.2012.02719.x">https://doi.org/10.1111/j.1365-2486.2012.02719.x</a>.
</div>
<div id="ref-Glibert2020" class="csl-entry" role="listitem">
Glibert, Patricia M. 2020. <span>‚ÄúHarmful Algal Blooms: A Climate Change Co-Stressor in Marine and Freshwater Ecosystems.‚Äù</span> <em>Harmful Algae</em> 91: 101590. <a href="https://doi.org/10.1016/j.hal.2019.03.008">https://doi.org/10.1016/j.hal.2019.03.008</a>.
</div>
<div id="ref-Glibert2001" class="csl-entry" role="listitem">
Glibert, Patricia M. et al. 2001. <span>‚ÄúThe Role of Eutrophication in the Global Proliferation of Harmful Algal Blooms.‚Äù</span> <em>Oceanography</em> 14 (2): 66‚Äì74. <a href="https://doi.org/10.5670/oceanog.2001.47">https://doi.org/10.5670/oceanog.2001.47</a>.
</div>
<div id="ref-Gregg2019" class="csl-entry" role="listitem">
Gregg, Watson W., and Cecile S. Rousseaux. 2019. <span>‚ÄúDecadal Changes in Global Phytoplankton Composition: Observations and Modeling.‚Äù</span> <em>Journal of Geophysical Research: Oceans</em> 124 (2): 983‚Äì1003. <a href="https://doi.org/10.1029/2018JC014173">https://doi.org/10.1029/2018JC014173</a>.
</div>
<div id="ref-Hirata2011" class="csl-entry" role="listitem">
Hirata, T., N. J. Hardman-Mountford, R. J. W. Brewin, J. Aiken, R. G. Barlow, K. Suzuki, T. Isada, et al. 2011. <span>‚ÄúSynoptic Relationships Between Surface Chlorophyll-a and Diagnostic Pigments Specific to Phytoplankton Functional Types.‚Äù</span> <em>Biogeosciences</em> 8 (2): 311‚Äì27. <a href="https://doi.org/10.5194/bg-8-311-2011">https://doi.org/10.5194/bg-8-311-2011</a>.
</div>
<div id="ref-IOCCG2014" class="csl-entry" role="listitem">
IOCCG. 2014. <span>‚ÄúPhytoplankton Functional Types from Space.‚Äù</span> No. 15. Edited by S. Sathyendranath. IOCCG Reports. Dartmouth, Canada: International Ocean-Colour Coordinating Group (IOCCG).
</div>
<div id="ref-Izadi2021" class="csl-entry" role="listitem">
Izadi, Moein, Mohamed Sultan, Racha El Kadiri, Amin Ghannadi, and Karem Abdelmohsen. 2021. <span>‚ÄúA Remote Sensing and Machine Learning-Based Approach to Forecast the Onset of Harmful Algal Bloom.‚Äù</span> <em>Remote Sensing</em> 13 (19): 3863. <a href="https://doi.org/10.3390/rs13193863">https://doi.org/10.3390/rs13193863</a>.
</div>
<div id="ref-Jeong2010" class="csl-entry" role="listitem">
Jeong, Hae Jin et al. 2010. <span>‚ÄúMixotrophy in the Marine Dinoflagellate Population: Physiological Roles, Relationships, and Regulation.‚Äù</span> <em>Harmful Algae</em> 9 (2): 154‚Äì65. <a href="https://doi.org/10.1016/j.hal.2009.08.005">https://doi.org/10.1016/j.hal.2009.08.005</a>.
</div>
<div id="ref-Kibler2015" class="csl-entry" role="listitem">
Kibler, Sarah R. et al. 2015. <span>‚ÄúGeographic and Vertical Distribution of Dinoflagellates in the Gulf of Mexico.‚Äù</span> <em>Journal of Phycology</em> 51 (4): 606‚Äì18. <a href="https://doi.org/10.1111/jpy.12302">https://doi.org/10.1111/jpy.12302</a>.
</div>
<div id="ref-Laufkotter2015" class="csl-entry" role="listitem">
Laufk√∂tter, C., M. Vogt, N. Gruber, O. Aumont, L. Bopp, S. C. Doney, J. P. Dunne, et al. 2015. <span>‚ÄúProjected Decreases in Future Marine Export Production: The Role of the Carbon Flux Through the Upper Ocean Ecosystem.‚Äù</span> <em>Biogeosciences</em> 13 (13): 4023‚Äì47. <a href="https://doi.org/10.5194/bg-13-4023-2016">https://doi.org/10.5194/bg-13-4023-2016</a>.
</div>
<div id="ref-Lundberg2017" class="csl-entry" role="listitem">
Lundberg, Scott M., and Su-In Lee. 2017. <span>‚ÄúA Unified Approach to Interpreting Model Predictions.‚Äù</span> In <em>Proceedings of the 31st International Conference on Neural Information Processing Systems (NeurIPS)</em>, 30:4768‚Äì77. Curran Associates, Inc. <a href="https://doi.org/10.48550/arXiv.1705.07874">https://doi.org/10.48550/arXiv.1705.07874</a>.
</div>
<div id="ref-Maranon2015" class="csl-entry" role="listitem">
Mara√±√≥n, E., P. Cermeno, M. Latasa, and R. D. Tadonl√©k√©. 2015. <span>‚ÄúResource Supply Overrides Temperature as a Controlling Factor of Marine Phytoplankton Growth.‚Äù</span> <em>PLoS ONE</em> 10 (6): e0130093. <a href="https://doi.org/10.1371/journal.pone.0130093">https://doi.org/10.1371/journal.pone.0130093</a>.
</div>
<div id="ref-Mouw2017" class="csl-entry" role="listitem">
Mouw, Colleen B., Neil J. Hardman-Mountford, Sylvie Alvain, Astrid Bracher, Robert J. W. Brewin, Annick Bricaud, Aurea M. Ciotti, et al. 2017. <span>‚ÄúA Consumer‚Äôs Guide to Satellite Remote Sensing of Multiple Phytoplankton Groups in the Global Ocean.‚Äù</span> <em>Frontiers in Marine Science</em> 4: 41. <a href="https://doi.org/10.3389/fmars.2017.00041">https://doi.org/10.3389/fmars.2017.00041</a>.
</div>
<div id="ref-Peperzak2003" class="csl-entry" role="listitem">
Peperzak, Louis. 2003. <span>‚ÄúClimate Change and Harmful Algal Blooms in the North Sea.‚Äù</span> <em>ICES Journal of Marine Science</em> 60 (2): 271‚Äì76. <a href="https://doi.org/10.1016/S1054-3139(03)00010-1">https://doi.org/10.1016/S1054-3139(03)00010-1</a>.
</div>
<div id="ref-Smayda2001" class="csl-entry" role="listitem">
Smayda, Theodore J., and Colin S. Reynolds. 2001. <span>‚ÄúCommunity Ecology of Harmful Algal Blooms in Coastal Upwelling Ecosystems.‚Äù</span> <em>ICES Journal of Marine Science</em> 58 (2): 374‚Äì76. <a href="https://doi.org/10.1006/jmsc.2001.1034">https://doi.org/10.1006/jmsc.2001.1034</a>.
</div>
<div id="ref-Yan2025" class="csl-entry" role="listitem">
Yan, Zhaojiang, Chong Fang, Kaishan Song, Xiangyu Wang, Zhidan Wen, Yingxin Shang, Hui Tao, and Yunfeng Lyu. 2025. <span>‚ÄúSpatiotemporal Variation in Biomass Abundance of Different Algal Species in Lake Hulun Using Machine Learning and Sentinel-3 Images.‚Äù</span> <em>Scientific Reports</em> 15: 2739. <a href="https://doi.org/10.1038/s41598-025-87338-4">https://doi.org/10.1038/s41598-025-87338-4</a>.
</div>
<div id="ref-Zhang2024" class="csl-entry" role="listitem">
Zhang, Yuan, Fang Shen, Renhu Li, Mengyu Li, Zhaoxin Li, Songyu Chen, and Xuerong Sun. 2024. <span>‚Äú<span>AIGD-PFT</span>: The First AI-Driven Global Daily Gap-Free 4&nbsp;Km Phytoplankton Functional Type Data Product from 1998 to 2023.‚Äù</span> <em>Earth System Science Data</em> 16: 4793‚Äì4816. <a href="https://doi.org/10.5194/essd-16-4793-2024">https://doi.org/10.5194/essd-16-4793-2024</a>.
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/erdemkarakoylu\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>